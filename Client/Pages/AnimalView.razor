@page "/animal/{Token}"
@page "/{Token}"
@using AnimalCollector.Shared.DTOs
@using AnimalCollector.Client.Models
@using System.Net.Http.Json
@inject HttpClient Http
@inject NavigationManager NavigationManager
@inject AuthService AuthService

<div class="page-container">
    <div class="page-header">
        <h1 class="page-title">Captured a new Critter!</h1>
    </div>

    <div class="page-content">
        @if (isLoading)
        {
            <div class="loading">
                <div class="spinner"></div>
                <p>Loading animal...</p>
            </div>
        }
        else if (errorMessage != null)
        {
            <div class="error-container">
                <p class="error">@errorMessage</p>
                <button class="btn-primary" @onclick="GoHome" data-testid="button-go-home">Go Home</button>
            </div>
        }
        else if (animal != null)
        {
            <div class="animal-detail">
                <img src="@animal.ImageUrl" alt="@animal.Name" class="animal-detail-image" />
                <h2>@animal.Name</h2>
                <p class="species">@animal.Species</p>
                <p class="habitat">üåç @animal.Habitat</p>
                <div class="rarity-badge rarity-@animal.Rarity">@animal.Rarity</div>
                
                <div class="facts">
                    <h3>Fun Facts:</h3>
                    @foreach (var fact in animal.Facts)
                    {
                        <p>‚Ä¢ @fact</p>
                    }
                </div>

                @if (AuthService.IsAuthenticated)
                {
                    @if (animal.Collected)
                    {
                        <div class="collected-status">
                            <p>‚úÖ Already in your collection!</p>
                        </div>
                        <button class="btn-secondary" @onclick="GoToCollection" data-testid="button-view-collection">
                            View Collection
                        </button>
                    }
                    else
                    {
                        <button class="btn-primary" @onclick="AddToCollection" disabled="@isCollecting" data-testid="button-add-to-collection">
                            @if (isCollecting)
                            {
                                <span>Adding...</span>
                            }
                            else
                            {
                                <span>Add to My Collection</span>
                            }
                        </button>
                    }
                }
                else
                {
                    <div class="auth-prompt">
                        <p>Sign in to add this critter to your collection!</p>
                        <button class="btn-primary" @onclick="ShowAuthModal" data-testid="button-show-auth">Sign In</button>
                    </div>
                }

                <button class="btn-secondary" @onclick="GoHome" data-testid="button-back">Back to Home</button>
            </div>
        }
    </div>
</div>

@if (showAuthModal)
{
    <div class="modal-overlay" @onclick="CloseAuthModal">
        <div class="modal-content auth-modal" @onclick:stopPropagation="true">
            <button class="modal-close" @onclick="CloseAuthModal">√ó</button>
            <h2>@(isLogin ? "Welcome Back!" : "Join Critter Wrangler")</h2>
            
            <form class="auth-form" @onsubmit="HandleAuth">
                <input type="email" 
                       placeholder="Email Address" 
                       @bind="username"
                       data-testid="input-username" />
                <input type="password" 
                       placeholder="Password" 
                       @bind="password"
                       data-testid="input-password" />
                @if (!isLogin)
                {
                    <input type="text" 
                           placeholder="Nickname (3-20 characters)" 
                           @bind="nickname"
                           data-testid="input-nickname" />
                }
                
                @if (authError != null)
                {
                    <p class="error">@authError</p>
                }

                <button type="submit" class="btn-primary" data-testid="button-auth-submit">
                    @(isLogin ? "Sign In" : "Sign Up")
                </button>
                
                @if (availableProviders.Any())
                {
                    <div class="auth-divider">
                        <span>or continue with</span>
                    </div>

                    <div class="external-auth-buttons">
                        @if (availableProviders.Contains("Google"))
                        {
                            <a href="/api/auth/external-login?provider=Google&returnUrl=/animal/@Token" class="btn-external-auth btn-google" data-testid="button-google-signin">
                                <img src="https://www.google.com/favicon.ico" alt="Google" />
                                <span>Google</span>
                            </a>
                        }
                        @if (availableProviders.Contains("Apple"))
                        {
                            <a href="/api/auth/external-login?provider=Apple&returnUrl=/animal/@Token" class="btn-external-auth btn-apple" data-testid="button-apple-signin">
                                <img src="https://www.apple.com/favicon.ico" alt="Apple" />
                                <span>Apple</span>
                            </a>
                        }
                    </div>
                }
            </form>

            <button class="btn-text" @onclick="ToggleAuthMode" data-testid="button-toggle-auth">
                @(isLogin ? "Need an account? Sign up" : "Already have an account? Sign in")
            </button>
        </div>
    </div>
}

<AchievementCelebration 
    IsVisible="@showCelebration" 
    Achievement="@unlockedAchievement" 
    OnClose="@OnCelebrationClose" />

@code {
    [Parameter]
    public string Token { get; set; } = string.Empty;

    private AnimalDTO? animal;
    private bool isLoading = true;
    private bool isCollecting = false;
    private string? errorMessage;
    private bool showAuthModal = false;
    private bool isLogin = true;
    private string username = "";
    private string password = "";
    private string nickname = "";
    private string? authError;
    private bool showCelebration = false;
    private Achievement? unlockedAchievement = null;
    private List<string> availableProviders = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadAnimal();
        await LoadAvailableProviders();
    }

    private async Task LoadAvailableProviders()
    {
        try
        {
            availableProviders = await Http.GetFromJsonAsync<List<string>>("/api/auth/providers") ?? new();
        }
        catch
        {
            availableProviders = new();
        }
    }

    private async Task LoadAnimal()
    {
        try
        {
            isLoading = true;
            errorMessage = null;

            var response = await Http.GetAsync($"api/animals/token/{Token}");
            if (response.IsSuccessStatusCode)
            {
                animal = await response.Content.ReadFromJsonAsync<AnimalDTO>();
            }
            else
            {
                errorMessage = "Animal not found. Please check the token and try again.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = "Failed to load animal. Please try again.";
            Console.WriteLine($"Error loading animal: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task AddToCollection()
    {
        if (animal == null) return;

        try
        {
            isCollecting = true;
            
            // Get stats before collection
            var statsBefore = await GetStats();
            
            // Collect the animal
            var response = await Http.PostAsync($"api/animals/{animal.Id}/collect", null);
            
            if (response.IsSuccessStatusCode)
            {
                // Get stats after collection
                var statsAfter = await GetStats();
                
                // Check for newly unlocked achievements
                var newAchievement = CheckNewAchievement(statsBefore, statsAfter);
                
                if (newAchievement != null)
                {
                    // Show celebration
                    unlockedAchievement = newAchievement;
                    showCelebration = true;
                }
                else
                {
                    // No new achievement, navigate immediately
                    NavigationManager.NavigateTo("/collection");
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error collecting animal: {ex.Message}");
        }
        finally
        {
            isCollecting = false;
        }
    }

    private async Task<StatsDTO?> GetStats()
    {
        try
        {
            return await Http.GetFromJsonAsync<StatsDTO>("api/animals/stats");
        }
        catch
        {
            return null;
        }
    }

    private Achievement? CheckNewAchievement(StatsDTO? before, StatsDTO? after)
    {
        if (before == null || after == null) return null;

        foreach (var achievement in Achievements.All)
        {
            var wasUnlocked = achievement.Condition(
                before.CollectedCount,
                before.LegendaryCount,
                before.TotalLegendaryCount,
                before.CompletionRate
            );

            var isNowUnlocked = achievement.Condition(
                after.CollectedCount,
                after.LegendaryCount,
                after.TotalLegendaryCount,
                after.CompletionRate
            );

            if (!wasUnlocked && isNowUnlocked)
            {
                return achievement;
            }
        }

        return null;
    }

    private void OnCelebrationClose()
    {
        showCelebration = false;
        NavigationManager.NavigateTo("/collection");
    }

    private void ShowAuthModal()
    {
        showAuthModal = true;
        isLogin = true;
        username = "";
        password = "";
        authError = null;
    }

    private void CloseAuthModal()
    {
        showAuthModal = false;
    }

    private void ToggleAuthMode()
    {
        isLogin = !isLogin;
        authError = null;
    }

    private async Task HandleAuth()
    {
        authError = null;

        if (string.IsNullOrWhiteSpace(username) || string.IsNullOrWhiteSpace(password))
        {
            authError = "Please enter both username and password";
            return;
        }

        try
        {
            AnimalCollector.Shared.DTOs.AuthResponse result;
            
            if (isLogin)
            {
                result = await AuthService.LoginAsync(username, password);
            }
            else
            {
                result = await AuthService.RegisterAsync(username, password, nickname);
            }

            if (result.Success)
            {
                CloseAuthModal();
                username = "";
                password = "";
                nickname = "";
                await LoadAnimal();
            }
            else
            {
                authError = result.Message;
            }
        }
        catch (Exception ex)
        {
            authError = "An error occurred. Please try again.";
            Console.WriteLine($"Auth error: {ex.Message}");
        }
    }

    private void GoHome()
    {
        NavigationManager.NavigateTo("/");
    }

    private void GoToCollection()
    {
        NavigationManager.NavigateTo("/collection");
    }
}
